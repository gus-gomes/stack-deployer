---
- name: Initialize Vault
  command: "vault operator init -key-shares=1 -key-threshold=1"
  register: vault_init
  environment:
    VAULT_ADDR: "http://{{Â ansible_default_ipv4.address }}:30080"

- name: Save Vault keys
  copy:
    content: "{{ vault_init.stdout }}"
    dest: /tmp/vault_keys.txt
  when: vault_init.changed

- name: Unseal Vault
  command: "vault operator unseal {{ item }}"
  with_items: "{{ vault_init.stdout_lines | select('search', 'Unseal Key') | map('regex_replace', 'Unseal Key \\d+: (.+)', '\\1') | list }}"
  environment:
    VAULT_ADDR: "http://{{ ansible_default_ipv4.address }}:30080"